


<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>qutip.qip.qasm &mdash; QuTiP 4.7 Documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-rendered-html.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/site.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="copyright" title="Copyright" href="../../../copyright.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> QuTiP: Quantum Toolbox in Python
          

          
          </a>

          
            
            
              <div class="version">
                4.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../frontmatter.html">Frontmatter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/guide.html">Users Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gallery/build/index.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apidoc/apidoc.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development/development.html">Development Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../biblio.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../copyright.html">Copyright and Licensing</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">QuTiP: Quantum Toolbox in Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>qutip.qip.qasm</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for qutip.qip.qasm</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">qutip.qip.circuit</span> <span class="kn">import</span> <span class="n">QubitCircuit</span>
<span class="kn">from</span> <span class="nn">qutip.qip.operations</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">controlled_gate</span><span class="p">,</span> <span class="n">qasmu_gate</span><span class="p">,</span> <span class="n">rz</span><span class="p">,</span> <span class="n">snot</span><span class="p">,</span> <span class="n">gate_sequence_product</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;read_qasm&quot;</span><span class="p">,</span> <span class="s2">&quot;save_qasm&quot;</span><span class="p">,</span> <span class="s2">&quot;print_qasm&quot;</span><span class="p">,</span> <span class="s2">&quot;circuit_to_qasm_str&quot;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">QasmGate</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class which stores the gate definitions as specified in the QASM file.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">gate_args</span><span class="p">,</span> <span class="n">gate_regs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_args</span> <span class="o">=</span> <span class="n">gate_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_regs</span> <span class="o">=</span> <span class="n">gate_regs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gates_inside</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">_get_qiskit_gates</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create and return a dictionary containing custom gates needed</span>
<span class="sd">    for &quot;qiskit&quot; mode. These include a subset of gates usually defined</span>
<span class="sd">    in the file &quot;qelib1.inc&quot;.</span>

<span class="sd">    Returns a dictionary mapping gate names to QuTiP gates.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">u2</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">qasmu_gate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">id</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">qasmu_gate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">sdg</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">rz</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tdg</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">rz</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cu3</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">controlled_gate</span><span class="p">(</span><span class="n">qasmu_gate</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">ch</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">controlled_gate</span><span class="p">(</span><span class="n">snot</span><span class="p">())</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ch&quot;</span><span class="p">:</span> <span class="n">ch</span><span class="p">,</span> <span class="s2">&quot;tdg&quot;</span><span class="p">:</span> <span class="n">tdg</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span> <span class="s2">&quot;u2&quot;</span><span class="p">:</span> <span class="n">u2</span><span class="p">,</span> <span class="s2">&quot;sdg&quot;</span><span class="p">:</span> <span class="n">sdg</span><span class="p">,</span> <span class="s2">&quot;cu3&quot;</span><span class="p">:</span> <span class="n">cu3</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">_tokenize_line</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Tokenize (break into several parts a string of) a single line of QASM code.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    command : str</span>
<span class="sd">        One line of QASM code to be broken into &quot;tokens&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tokens : list of str</span>
<span class="sd">        The tokens (parts) corresponding to the qasm line taken as input.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># for gates without arguments</span>
    <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]))</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
    <span class="c1"># for classically controlled gates</span>
    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*if\s*\(&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*if\s*\((.*)\)\s*(.*)\s+\((.*)\)(.*)&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
        <span class="c1"># for classically controlled gates with arguments</span>
        <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;)&quot;</span><span class="p">]</span>
            <span class="n">tokens_gate</span> <span class="o">=</span> <span class="n">_tokenize_line</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                                                             <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                                                             <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
            <span class="n">tokens</span> <span class="o">+=</span> <span class="n">tokens_gate</span>
        <span class="c1"># for classically controlled gates without arguments</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*if\s*\((.*)\)(.*)&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;if&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;)&quot;</span><span class="p">]</span>
            <span class="n">tokens_gate</span> <span class="o">=</span> <span class="n">_tokenize_line</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">tokens</span> <span class="o">+=</span> <span class="n">tokens_gate</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
    <span class="c1"># for gates with arguments</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(^.*?)\((.*)\)(.*)&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;QASM: Incorrect bracket formatting&quot;</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">+=</span> <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">+=</span> <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">tokens</span>


<span class="k">def</span> <span class="nf">_tokenize</span><span class="p">(</span><span class="n">token_cmds</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Tokenize QASM code for processing, i.e. break it into several parts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    token_cmds : list of str</span>
<span class="sd">        Lines of QASM code.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tokens : list of (list of str)</span>
<span class="sd">        List of tokens corresponding to each QASM line taken as input.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">processed_commands</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">token_cmds</span><span class="p">:</span>

        <span class="c1"># carry out some pre-processing for convenience</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;[]()&quot;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot; ; &quot;</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot; ; &quot;</span><span class="p">)</span>
        <span class="n">line_commands</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">line_commands</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line_commands</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">line_commands</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">_tokenize_line</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="n">processed_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">!=</span> <span class="p">[],</span> <span class="n">processed_commands</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_gate_processor</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Process tokens for a gate call statement separating them into args and regs.</span>
<span class="sd">    Processes tokens from a &quot;gate call&quot; (e.g. rx(pi) q[0]) and returns the</span>
<span class="sd">    tokens for the arguments and registers separately.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">gate_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gate_regs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">reg_start</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># extract arguments</span>
    <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="ow">and</span> <span class="s2">&quot;)&quot;</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="n">bopen</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
        <span class="n">bclose</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="n">gate_args</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">bopen</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">bclose</span><span class="p">]</span>
        <span class="n">reg_start</span> <span class="o">=</span> <span class="n">bclose</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># extract registers</span>
    <span class="n">gate_regs</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">reg_start</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">gate_args</span><span class="p">,</span> <span class="n">gate_regs</span>


<span class="k">class</span> <span class="nc">QasmProcessor</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class which holds variables used in processing QASM code.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;qiskit&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qubit_regs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cbit_regs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_qubits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_cbits</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qasm_gates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predefined_gates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;CX&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;qiskit&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qiskitgates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;u3&quot;</span><span class="p">,</span> <span class="s2">&quot;u2&quot;</span><span class="p">,</span> <span class="s2">&quot;u1&quot;</span><span class="p">,</span> <span class="s2">&quot;cx&quot;</span><span class="p">,</span>  <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;sdg&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;tdg&quot;</span><span class="p">,</span> <span class="s2">&quot;rx&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;ry&quot;</span><span class="p">,</span> <span class="s2">&quot;rz&quot;</span><span class="p">,</span> <span class="s2">&quot;cz&quot;</span><span class="p">,</span> <span class="s2">&quot;cy&quot;</span><span class="p">,</span> <span class="s2">&quot;ch&quot;</span><span class="p">,</span> <span class="s2">&quot;ccx&quot;</span><span class="p">,</span> <span class="s2">&quot;crz&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cu1&quot;</span><span class="p">,</span> <span class="s2">&quot;cu3&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predefined_gates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefined_gates</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qiskitgates</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gate_names</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predefined_gates</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefined_gates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qasm_gates</span><span class="p">[</span><span class="n">gate</span><span class="p">]</span> <span class="o">=</span> <span class="n">QasmGate</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span>
                                             <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">],</span>
                                             <span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">commands</span>

    <span class="k">def</span> <span class="nf">_process_includes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        QASM allows for code to be specified in additional files with the</span>
<span class="sd">        &quot;.inc&quot; extension, especially to specify gate definitions in terms of</span>
<span class="sd">        the built-in gates. Process into tokens all the</span>
<span class="sd">        additional files and insert it into previously processed list.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">prev_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">expanded_commands</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">curr_index</span><span class="p">,</span> <span class="n">command</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;include&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;qiskit&quot;</span> <span class="ow">and</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;qelib1.inc&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">qasm_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span>
                                  <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]</span>
                    <span class="n">qasm_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
                                      <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;//&quot;</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                      <span class="n">qasm_lines</span><span class="p">))</span>

                    <span class="n">expanded_commands</span> <span class="o">=</span> <span class="p">(</span><span class="n">expanded_commands</span>
                                         <span class="o">+</span> <span class="n">command</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:</span><span class="n">curr_index</span><span class="p">]</span>
                                         <span class="o">+</span> <span class="n">_tokenize</span><span class="p">(</span><span class="n">qasm_lines</span><span class="p">))</span>
                    <span class="n">prev_index</span> <span class="o">=</span> <span class="n">curr_index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;: such a file does not exist&quot;</span><span class="p">)</span>

        <span class="n">expanded_commands</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="n">prev_index</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">expanded_commands</span>

    <span class="k">def</span> <span class="nf">_initialize_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Passes through the tokenized commands, create QasmGate objects for</span>
<span class="sd">        each user-defined gate, process register declarations.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">gate_defn_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">open_bracket_mode</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">unprocessed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">command</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">gate_defn_mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;{&quot;</span><span class="p">:</span>
                    <span class="n">gate_defn_mode</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">open_bracket_mode</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">gate_elems</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;QASM: incorrect bracket formatting&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">open_bracket_mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;{&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;QASM: incorrect bracket formatting&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;}&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">curr_gate</span><span class="o">.</span><span class="n">gates_inside</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;QASM: opaque gate </span><span class="si">{}</span><span class="s2"> are  </span><span class="se">\</span>
<span class="s2">                                                   not allowed, please define </span><span class="se">\</span>
<span class="s2">                                                   or omit </span><span class="se">\</span>
<span class="s2">                                                   them&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curr_gate</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="n">open_bracket_mode</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gate_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">curr_gate</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qasm_gates</span><span class="p">[</span><span class="n">curr_gate</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_gate</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_names</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">gate_args</span><span class="p">,</span> <span class="n">gate_regs</span> <span class="o">=</span> <span class="n">_gate_processor</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                    <span class="n">gate_added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qasm_gates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">curr_gate</span><span class="o">.</span><span class="n">gates_inside</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span>
                                                   <span class="n">gate_args</span><span class="p">,</span>
                                                   <span class="n">gate_regs</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;gate&quot;</span><span class="p">:</span>
                <span class="n">gate_name</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">gate_args</span><span class="p">,</span> <span class="n">gate_regs</span> <span class="o">=</span> <span class="n">_gate_processor</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">curr_gate</span> <span class="o">=</span> <span class="n">QasmGate</span><span class="p">(</span><span class="n">gate_name</span><span class="p">,</span> <span class="n">gate_args</span><span class="p">,</span> <span class="n">gate_regs</span><span class="p">)</span>
                <span class="n">gate_defn_mode</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;qreg&quot;</span><span class="p">:</span>
                <span class="n">groups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.*)\[(.*)\]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="n">qubit_name</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">num_regs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qubit_regs</span><span class="p">[</span><span class="n">qubit_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">num_qubits</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">num_qubits</span> <span class="o">+</span> <span class="n">num_regs</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_qubits</span> <span class="o">+=</span> <span class="n">num_regs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;QASM: incorrect bracket formatting&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;creg&quot;</span><span class="p">:</span>
                <span class="n">groups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.*)\[(.*)\]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="n">cbit_name</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">num_regs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cbit_regs</span><span class="p">[</span><span class="n">cbit_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_cbits</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">num_cbits</span> <span class="o">+</span> <span class="n">num_regs</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_cbits</span> <span class="o">+=</span> <span class="n">num_regs</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;QASM: incorrect bracket formatting&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;reset&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">((</span><span class="s2">&quot;QASM: reset functionality &quot;</span>
                                           <span class="s2">&quot;is not supported.&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;barrier&quot;</span><span class="p">,</span> <span class="s2">&quot;include&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unprocessed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">open_bracket_mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;QASM: incorrect bracket formatting&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unprocessed</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_custom_gate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qc_temp</span><span class="p">,</span> <span class="n">gate_call</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Recursively process a custom-defined gate with specified arguments</span>
<span class="sd">        to produce a dummy circuit with all the gates in the custom-defined</span>
<span class="sd">        gate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        qc_temp: :class:`.QubitCircuit`</span>
<span class="sd">            temporary circuit to process custom gate</span>
<span class="sd">        gate_call: list of str</span>
<span class="sd">            tokens corresponding to gate signature/call</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">gate_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">regs</span> <span class="o">=</span> <span class="n">gate_call</span>
        <span class="n">gate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qasm_gates</span><span class="p">[</span><span class="n">gate_name</span><span class="p">]</span>
        <span class="n">args_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">regs_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># maps variables to supplied arguments, registers</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">gate_args</span><span class="p">):</span>
            <span class="n">args_map</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">gate_regs</span><span class="p">):</span>
            <span class="n">regs_map</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># process all the constituent gates with supplied arguments, registers</span>
        <span class="k">for</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">gate</span><span class="o">.</span><span class="n">gates_inside</span><span class="p">:</span>

            <span class="c1"># create function call for the constituent gate</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">com_args</span><span class="p">,</span> <span class="n">com_regs</span> <span class="o">=</span> <span class="n">call</span>

            <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">real_arg</span> <span class="ow">in</span> <span class="n">args_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">com_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">real_arg</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">com_args</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">reg</span><span class="p">,</span> <span class="n">real_reg</span> <span class="ow">in</span> <span class="n">regs_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">com_regs</span> <span class="o">=</span> <span class="p">[</span><span class="n">command</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">real_reg</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">com_regs</span><span class="p">]</span>
            <span class="n">com_args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">com_args</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefined_gates</span><span class="p">:</span>
                <span class="n">qc_temp</span><span class="o">.</span><span class="n">user_gates</span> <span class="o">=</span> <span class="n">_get_qiskit_gates</span><span class="p">()</span>
                <span class="n">com_regs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">com_regs</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_predefined_gates</span><span class="p">(</span><span class="n">qc_temp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">com_regs</span><span class="p">,</span> <span class="n">com_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_custom_gate</span><span class="p">(</span><span class="n">qc_temp</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">com_args</span><span class="p">,</span> <span class="n">com_regs</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_regs_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Process register tokens: map them to the :class:`.QubitCircuit` indices</span>
<span class="sd">        of the respective registers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        regs : list of str</span>
<span class="sd">            Token list corresponding to qubit/cbit register invocations.</span>
<span class="sd">        reg_type : str</span>
<span class="sd">            reg_type can be &quot;measure&quot; or &quot;gate&quot; to specify type of required</span>
<span class="sd">            processing.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        regs list : list of (list of regs)</span>
<span class="sd">                list of register sets to which circuit operations</span>
<span class="sd">                are applied.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># turns messy tokens into appropriate form</span>
        <span class="c1"># [&#39;q&#39;, &#39;p&#39;, &#39;[&#39;, &#39;0&#39;, &#39;]&#39;] -&gt; [&#39;q&#39;, &#39;p[0]&#39;]</span>
        <span class="n">regs</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>
            <span class="n">prev_token</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">new_regs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">open_bracket_mode</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;[&quot;</span><span class="p">:</span>
                    <span class="n">open_bracket_mode</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">open_bracket_mode</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;]&quot;</span><span class="p">:</span>
                        <span class="n">open_bracket_mode</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">reg_name</span> <span class="o">=</span> <span class="n">new_regs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="n">new_regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_name</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">reg_num</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">reg_num</span> <span class="o">=</span> <span class="n">token</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;QASM: incorrect bracket formatting&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">open_bracket_mode</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;QASM: incorrect bracket formatting&quot;</span><span class="p">)</span>
            <span class="n">regs</span> <span class="o">=</span> <span class="n">new_regs</span>

        <span class="k">if</span> <span class="n">reg_type</span> <span class="o">==</span> <span class="s2">&quot;measure&quot;</span><span class="p">:</span>

            <span class="c1"># processes register tokens of the form q[i] -&gt; c[i]</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.*)\[(.*)\]-&gt;(.*)\[(.*)\]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">qubit_name</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">qubit_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">qubit_lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qubit_regs</span><span class="p">[</span><span class="n">qubit_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">qubit_ind</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_lst</span><span class="p">):</span>
                    <span class="n">qubit</span> <span class="o">=</span> <span class="n">qubit_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qubit_ind</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;QASM: qubit index out of bounds&quot;</span><span class="p">)</span>
                <span class="n">cbit_name</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">cbit_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">cbit_lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbit_regs</span><span class="p">[</span><span class="n">cbit_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cbit_ind</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbit_lst</span><span class="p">):</span>
                    <span class="n">cbit</span> <span class="o">=</span> <span class="n">cbit_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cbit_ind</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;QASM: cbit index out of bounds&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">qubit</span><span class="p">,</span> <span class="n">cbit</span><span class="p">)]</span>
            <span class="c1"># processes register tokens of the form q -&gt; c</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qubit_name</span> <span class="o">=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cbit_name</span> <span class="o">=</span> <span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">qubits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qubit_regs</span><span class="p">[</span><span class="n">qubit_name</span><span class="p">]</span>
                <span class="n">cbits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbit_regs</span><span class="p">[</span><span class="n">cbit_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubits</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbits</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qubits</span><span class="p">,</span> <span class="n">cbits</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;QASM: qubit and cbit </span><span class="se">\</span>
<span class="s2">                                     register sizes are different&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># processes gate tokens to create sets of registers to</span>
            <span class="c1"># which the gates are applied.</span>
            <span class="n">new_regs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">expand</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">:</span>
                    <span class="n">groups</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.*)\[(.*)\]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span>
                    <span class="n">qubit_name</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">qubit_ind</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">qubit_lst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qubit_regs</span><span class="p">[</span><span class="n">qubit_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">qubit_ind</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit_lst</span><span class="p">):</span>
                        <span class="n">qubit</span> <span class="o">=</span> <span class="n">qubit_lst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qubit_ind</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qubit_name</span> <span class="o">=</span> <span class="n">reg</span>
                    <span class="n">qubit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qubit_regs</span><span class="p">[</span><span class="n">qubit_name</span><span class="p">]</span>
                    <span class="n">expand</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qubit</span><span class="p">)</span>
                <span class="n">new_regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qubit</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expand</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">expand</span><span class="p">,</span>
                        <span class="n">new_regs</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">new_regs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_add_qiskit_gates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">classical_controls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">control_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add any gates that are pre-defined in qiskit-style exported</span>
<span class="sd">        qasm file with included &quot;qelib1.inc&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        qc : :class:`.QubitCircuit`</span>
<span class="sd">            the circuit to which the gate is added.</span>
<span class="sd">        name : str</span>
<span class="sd">            name of gate to be added.</span>
<span class="sd">        regs : list of int</span>
<span class="sd">            list of qubit register indices to add gates to.</span>
<span class="sd">        args : float, optional</span>
<span class="sd">            value of args supplied to the gate.</span>
<span class="sd">        classical_controls : list of int, optional</span>
<span class="sd">            indices of classical bits to control gate on.</span>
<span class="sd">        control_value : int, optional</span>
<span class="sd">            value of classical bits to control on, the classical controls are</span>
<span class="sd">            interpreted as an integer with lowest bit being the first one.</span>
<span class="sd">            If not specified, then the value is interpreted to be</span>
<span class="sd">            2 ** len(classical_controls) - 1</span>
<span class="sd">            (i.e. all classical controls are 1).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">gate_name_map_1q</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="s2">&quot;SNOT&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;sdg&quot;</span><span class="p">:</span> <span class="s2">&quot;sdg&quot;</span><span class="p">,</span> <span class="s2">&quot;tdg&quot;</span><span class="p">:</span> <span class="s2">&quot;tdg&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;rx&quot;</span><span class="p">:</span> <span class="s2">&quot;RX&quot;</span><span class="p">,</span> <span class="s2">&quot;ry&quot;</span><span class="p">:</span> <span class="s2">&quot;RY&quot;</span><span class="p">,</span> <span class="s2">&quot;rz&quot;</span><span class="p">:</span> <span class="s2">&quot;RZ&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;u3&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;QASMU&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg_value</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;u2&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;u2&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg_value</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;u1&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;RZ&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg_value</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cz&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;CZ&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">controls</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cy&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;CY&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">controls</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;ch&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;ch&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">,</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;ccx&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;TOFFOLI&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">controls</span><span class="o">=</span><span class="n">regs</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;crz&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;CRZ&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">controls</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">arg_value</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cu1&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;CPHASE&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">controls</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">arg_value</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cu3&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;cu3&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                        <span class="n">arg_value</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cx&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;CNOT&quot;</span><span class="p">,</span>  <span class="n">targets</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">controls</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">gate_name_map_1q</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">gate_name_map_1q</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg_value</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_predefined_gates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">com_regs</span><span class="p">,</span> <span class="n">com_args</span><span class="p">,</span>
                              <span class="n">classical_controls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">control_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add any gates that are pre-defined and/or inbuilt</span>
<span class="sd">        in our circuit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        qc : :class:`.QubitCircuit`</span>
<span class="sd">            the circuit to which the gate is added.</span>
<span class="sd">        name : str</span>
<span class="sd">            name of gate to be added.</span>
<span class="sd">        regs : list of int</span>
<span class="sd">            list of qubit register indices to add gates to.</span>
<span class="sd">        args : float, optional</span>
<span class="sd">            value of args supplied to the gate.</span>
<span class="sd">        classical_controls : list of int, optional</span>
<span class="sd">            indices of classical bits to control gate on.</span>
<span class="sd">        control_value : int, optional</span>
<span class="sd">            value of classical bits to control on, the classical controls are</span>
<span class="sd">            interpreted as an integer with lowest bit being the first one.</span>
<span class="sd">            If not specified, then the value is interpreted to be</span>
<span class="sd">            2 ** len(classical_controls) - 1</span>
<span class="sd">            (i.e. all classical controls are 1).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;CX&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;CNOT&quot;</span><span class="p">,</span>
                        <span class="n">targets</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">com_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="n">controls</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">com_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="s2">&quot;QASMU&quot;</span><span class="p">,</span>
                        <span class="n">targets</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">com_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">arg_value</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">com_args</span><span class="p">],</span>
                        <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                        <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">qiskitgates</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;qiskit&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_qiskit_gates</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">com_regs</span><span class="p">,</span> <span class="n">com_args</span><span class="p">,</span>
                                   <span class="n">classical_controls</span><span class="p">,</span> <span class="n">control_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_gate_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">custom_gates</span><span class="p">,</span>
                  <span class="n">classical_controls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">control_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add gates to :class:`.QubitCircuit` from processed tokens,</span>
<span class="sd">        define custom gates if necessary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        qc: :class:`.QubitCircuit`</span>
<span class="sd">            circuit object to which gate is added</span>
<span class="sd">        command: list of str</span>
<span class="sd">            list of tokens corresponding to gate application</span>
<span class="sd">        custom_gates: {gate name : gate function or unitary}</span>
<span class="sd">            dictionary of user gates defined for qutip</span>
<span class="sd">        classical_controls : int or list of int, optional</span>
<span class="sd">            indices of classical bits to control gate on.</span>
<span class="sd">        control_value : int, optional</span>
<span class="sd">            value of classical bits to control on, the classical controls are</span>
<span class="sd">            interpreted as an integer with lowest bit being the first one.</span>
<span class="sd">            If not specified, then the value is interpreted to be</span>
<span class="sd">            2 ** len(classical_controls) - 1</span>
<span class="sd">            (i.e. all classical controls are 1).</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">args</span><span class="p">,</span> <span class="n">regs</span> <span class="o">=</span> <span class="n">_gate_processor</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">reg_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regs_processor</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="s2">&quot;gate&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">gate_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gate_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># creates custom-gate (if required) using gate defn and provided args</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefined_gates</span>
                <span class="ow">and</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">custom_gates</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reg_set</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">qc_temp</span> <span class="o">=</span> <span class="n">QubitCircuit</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_custom_gate</span><span class="p">(</span><span class="n">qc_temp</span><span class="p">,</span>
                              <span class="p">[</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]])</span>
            <span class="n">unitary_mat</span> <span class="o">=</span> <span class="n">gate_sequence_product</span><span class="p">(</span><span class="n">qc_temp</span><span class="o">.</span><span class="n">propagators</span><span class="p">())</span>
            <span class="n">custom_gates</span><span class="p">[</span><span class="n">gate_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">unitary_mat</span>

        <span class="n">qc</span><span class="o">.</span><span class="n">user_gates</span> <span class="o">=</span> <span class="n">custom_gates</span>

        <span class="c1"># adds gate to the QubitCircuit</span>
        <span class="k">for</span> <span class="n">regs</span> <span class="ow">in</span> <span class="n">reg_set</span><span class="p">:</span>
            <span class="n">regs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">regs</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefined_gates</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_predefined_gates</span><span class="p">(</span>
                                    <span class="n">qc</span><span class="p">,</span>
                                    <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">regs</span><span class="p">,</span>
                                    <span class="n">args</span><span class="p">,</span>
                                    <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                                    <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">regs</span> <span class="o">=</span> <span class="p">[</span><span class="n">regs</span><span class="p">]</span>
                <span class="n">qc</span><span class="o">.</span><span class="n">add_gate</span><span class="p">(</span><span class="n">gate_name</span><span class="p">,</span>
                            <span class="n">targets</span><span class="o">=</span><span class="n">regs</span><span class="p">,</span>
                            <span class="n">classical_controls</span><span class="o">=</span><span class="n">classical_controls</span><span class="p">,</span>
                            <span class="n">control_value</span><span class="o">=</span><span class="n">control_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_final_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qc</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Take a blank circuit, add all the gates and measurements specified</span>
<span class="sd">        by QASM.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">custom_gates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;qiskit&quot;</span><span class="p">:</span>
            <span class="n">custom_gates</span> <span class="o">=</span> <span class="n">_get_qiskit_gates</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_names</span><span class="p">:</span>
                <span class="c1"># adds gates to the QubitCircuit</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gate_add</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">custom_gates</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;measure&quot;</span><span class="p">:</span>
                <span class="c1"># adds measurement to the QubitCircuit</span>
                <span class="n">reg_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regs_processor</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&quot;measure&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">regs</span> <span class="ow">in</span> <span class="n">reg_set</span><span class="p">:</span>
                    <span class="n">qc</span><span class="o">.</span><span class="n">add_measurement</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                       <span class="n">classical_store</span><span class="o">=</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;if&quot;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span><span class="s2">&quot;Information about individual registers&quot;</span>
                              <span class="s2">&quot; is not preserved in QubitCircuit&quot;</span><span class="p">))</span>
                <span class="c1"># adds classically controlled gates to the QubitCircuit</span>
                <span class="n">cbit_reg</span><span class="p">,</span> <span class="n">control_value</span> <span class="o">=</span> <span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;==&quot;</span><span class="p">)</span>
                <span class="n">cbit_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cbit_regs</span><span class="p">[</span><span class="n">cbit_reg</span><span class="p">]</span>
                <span class="n">control_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">control_value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gate_add</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">command</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="n">custom_gates</span><span class="p">,</span>
                               <span class="n">cbit_inds</span><span class="p">,</span> <span class="n">control_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;QASM: </span><span class="si">{}</span><span class="s2"> is not a valid QASM command.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>


<div class="viewcode-block" id="read_qasm"><a class="viewcode-back" href="../../../apidoc/functions.html#qutip.qip.qasm.read_qasm">[docs]</a><span class="k">def</span> <span class="nf">read_qasm</span><span class="p">(</span><span class="n">qasm_input</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;qiskit&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="n">strmode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read OpenQASM intermediate representation</span>
<span class="sd">    (https://github.com/Qiskit/openqasm) and return</span>
<span class="sd">    a :class:`.QubitCircuit` and state inputs as specified in the</span>
<span class="sd">    QASM file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    qasm_input : str</span>
<span class="sd">        File location or String Input for QASM file to be imported. In case of</span>
<span class="sd">        string input, the parameter strmode must be True.</span>
<span class="sd">    mode : str</span>
<span class="sd">        QASM mode to be read in. When mode is &quot;qiskit&quot;,</span>
<span class="sd">        the &quot;qelib1.inc&quot; include is automatically included,</span>
<span class="sd">        without checking externally. Otherwise, each include is</span>
<span class="sd">        processed.</span>
<span class="sd">    version : str</span>
<span class="sd">        QASM version of the QASM file. Only version 2.0 is currently supported.</span>
<span class="sd">    strmode : bool</span>
<span class="sd">        if specified as True, indicates that qasm_input is in string format</span>
<span class="sd">        rather than from file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    qc : :class:`.QubitCircuit`</span>
<span class="sd">        Returns a :class:`.QubitCircuit` object specified in the QASM file.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">strmode</span><span class="p">:</span>
        <span class="n">qasm_lines</span> <span class="o">=</span> <span class="n">qasm_input</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">qasm_input</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">qasm_lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># split input into lines and ignore comments</span>
    <span class="n">qasm_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">qasm_lines</span><span class="p">]</span>
    <span class="n">qasm_lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;//&quot;</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">qasm_lines</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="s2">&quot;2.0&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;QASM: Only OpenQASM 2.0 </span><span class="se">\</span>
<span class="s2">                                  is currently supported.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">qasm_lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;OPENQASM 2.0;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;QASM: File does not contain QASM 2.0 header&quot;</span><span class="p">)</span>

    <span class="n">qasm_obj</span> <span class="o">=</span> <span class="n">QasmProcessor</span><span class="p">(</span><span class="n">qasm_lines</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
    <span class="n">qasm_obj</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">_tokenize</span><span class="p">(</span><span class="n">qasm_obj</span><span class="o">.</span><span class="n">commands</span><span class="p">)</span>

    <span class="n">qasm_obj</span><span class="o">.</span><span class="n">_process_includes</span><span class="p">()</span>

    <span class="n">qasm_obj</span><span class="o">.</span><span class="n">_initialize_pass</span><span class="p">()</span>
    <span class="n">qc</span> <span class="o">=</span> <span class="n">QubitCircuit</span><span class="p">(</span><span class="n">qasm_obj</span><span class="o">.</span><span class="n">num_qubits</span><span class="p">,</span> <span class="n">num_cbits</span><span class="o">=</span><span class="n">qasm_obj</span><span class="o">.</span><span class="n">num_cbits</span><span class="p">)</span>

    <span class="n">qasm_obj</span><span class="o">.</span><span class="n">_final_pass</span><span class="p">(</span><span class="n">qc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">qc</span></div>


<span class="n">_GATE_NAME_TO_QASM_NAME</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;QASMU&quot;</span><span class="p">:</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RX&quot;</span><span class="p">:</span> <span class="s2">&quot;rx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RY&quot;</span><span class="p">:</span> <span class="s2">&quot;ry&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RZ&quot;</span><span class="p">:</span> <span class="s2">&quot;rz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SNOT&quot;</span><span class="p">:</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span>
    <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CRZ&quot;</span><span class="p">:</span> <span class="s2">&quot;crz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CNOT&quot;</span><span class="p">:</span> <span class="s2">&quot;cx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TOFFOLI&quot;</span><span class="p">:</span> <span class="s2">&quot;ccx&quot;</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">QasmOutput</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for QASM export.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    version: str, optional</span>
<span class="sd">        OpenQASM version, currently must be &quot;2.0&quot; necessarily.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_name_map</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">_GATE_NAME_TO_QASM_NAME</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Pipe QASM output string to QasmOutput&#39;s lines variable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        line: str, optional</span>
<span class="sd">            string to be appended to QASM output.</span>
<span class="sd">        n: int, optional</span>
<span class="sd">            number of blank lines to be appended to QASM output.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resets QasmOutput variables.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_name_map</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">_GATE_NAME_TO_QASM_NAME</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_qasm_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q_name</span><span class="p">,</span> <span class="n">q_controls</span><span class="p">,</span> <span class="n">q_targets</span><span class="p">,</span> <span class="n">q_args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns QASM string for gate definition or gate application given</span>
<span class="sd">        name, registers, arguments.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">q_controls</span><span class="p">:</span>
            <span class="n">q_controls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">q_regs</span> <span class="o">=</span> <span class="n">q_controls</span> <span class="o">+</span> <span class="n">q_targets</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q_targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">q_regs</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;q[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="n">q_regs</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q_regs</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">q_regs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">q_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">q_args</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">q_args</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">q_args</span><span class="p">])</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q_name</span><span class="p">,</span> <span class="n">q_args</span><span class="p">,</span> <span class="n">q_regs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q_name</span><span class="p">,</span> <span class="n">q_regs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_qasm_defn_from_resolved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curr_gate</span><span class="p">,</span> <span class="n">gates_lst</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resolve QASM definition of QuTiP gate in terms of component gates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        curr_gate: :class:`.Gate`</span>
<span class="sd">            QuTiP gate which needs to be resolved into component gates.</span>
<span class="sd">        gates_lst: list of :class:`.Gate`</span>
<span class="sd">            list of gate that constitute QASM definition of self.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">forbidden_gates</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GLOBALPHASE&quot;</span><span class="p">,</span> <span class="s2">&quot;PHASEGATE&quot;</span><span class="p">]</span>
        <span class="n">reg_map</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span>

        <span class="n">q_controls</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">curr_gate</span><span class="o">.</span><span class="n">controls</span><span class="p">:</span>
            <span class="n">q_controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">curr_gate</span><span class="o">.</span><span class="n">controls</span><span class="p">]</span>
        <span class="n">q_targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">curr_gate</span><span class="o">.</span><span class="n">targets</span><span class="p">]</span>
        <span class="n">arg_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">curr_gate</span><span class="o">.</span><span class="n">arg_value</span><span class="p">:</span>
            <span class="n">arg_name</span> <span class="o">=</span> <span class="s2">&quot;theta&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;gate </span><span class="si">{}</span><span class="s2"> {{&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qasm_str</span><span class="p">(</span><span class="n">curr_gate</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                                                       <span class="n">q_controls</span><span class="p">,</span>
                                                       <span class="n">q_targets</span><span class="p">,</span>
                                                       <span class="n">arg_name</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">gate</span> <span class="ow">in</span> <span class="n">gates_lst</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_name_map</span><span class="p">:</span>
                <span class="n">gate</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gate</span><span class="o">.</span><span class="n">targets</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">gate</span><span class="o">.</span><span class="n">controls</span><span class="p">:</span>
                    <span class="n">gate</span><span class="o">.</span><span class="n">controls</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gate</span><span class="o">.</span><span class="n">controls</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qasm_str</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">gate_name_map</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                                <span class="n">gate</span><span class="o">.</span><span class="n">controls</span><span class="p">,</span>
                                <span class="n">gate</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span>
                                <span class="n">gate</span><span class="o">.</span><span class="n">arg_value</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">forbidden_gates</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;The given resolved gate </span><span class="si">{}</span><span class="s2"> cannot be defined&quot;</span>
                                  <span class="s2">&quot; in QASM format&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curr_gate</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_qasm_defn_resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gate</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resolve QASM definition of QuTiP gate if possible.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gate: :class:`.Gate`</span>
<span class="sd">            QuTiP gate which needs to be resolved into component gates.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">qc</span> <span class="o">=</span> <span class="n">QubitCircuit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">gates_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;CSIGN&quot;</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">_gate_CSIGN</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">gates_lst</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;No definition specified for </span><span class="si">{}</span><span class="s2"> gate&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_qasm_defn_from_resolved</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">gates_lst</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_name_map</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_qasm_defns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gate</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Define QASM gates for QuTiP gates that do not have QASM counterparts.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gate: :class:`.Gate`</span>
<span class="sd">            QuTiP gate which needs to be defined in QASM format.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;CRY&quot;</span><span class="p">:</span>
            <span class="n">gate_def</span> <span class="o">=</span> <span class="s2">&quot;gate cry(theta) a,b { cu3(theta,0,0) a,b; }&quot;</span>
        <span class="k">elif</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;CRX&quot;</span><span class="p">:</span>
            <span class="n">gate_def</span> <span class="o">=</span> <span class="s2">&quot;gate crx(theta) a,b { cu3(theta,-pi/2,pi/2) a,b; }&quot;</span>
        <span class="k">elif</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;SQRTNOT&quot;</span><span class="p">:</span>
            <span class="n">gate_def</span> <span class="o">=</span> <span class="s2">&quot;gate sqrtnot a {h a; u1(-pi/2) a; h a; }&quot;</span>
        <span class="k">elif</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;CS&quot;</span><span class="p">:</span>
            <span class="n">gate_def</span> <span class="o">=</span> <span class="s2">&quot;gate cs a,b { cu1(pi/2) a,b; }&quot;</span>
        <span class="k">elif</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;CT&quot;</span><span class="p">:</span>
            <span class="n">gate_def</span> <span class="o">=</span> <span class="s2">&quot;gate ct a,b { cu1(pi/4) a,b; }&quot;</span>
        <span class="k">elif</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;SWAP&quot;</span><span class="p">:</span>
            <span class="n">gate_def</span> <span class="o">=</span> <span class="s2">&quot;gate swap a,b { cx a,b; cx b,a; cx a,b; }&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qasm_defn_resolve</span><span class="p">(</span><span class="n">gate</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;// QuTiP definition for gate </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">gate_def</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_name_map</span><span class="p">[</span><span class="n">gate</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gate</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">qasm_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gate_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return QASM gate name for corresponding QuTiP gate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gate_name: str</span>
<span class="sd">            QuTiP gate name.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">gate_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_name_map</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_name_map</span><span class="p">[</span><span class="n">gate_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">is_defined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gate_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if QASM gate definition exists for QuTiP gate.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gate_name: str</span>
<span class="sd">            QuTiP gate name.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">gate_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_name_map</span>

    <span class="k">def</span> <span class="nf">_qasm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qc</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        QASM output handler.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        qc: :class:`.QubitCircuit`</span>
<span class="sd">            circuit object to produce QASM output for.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_flush</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;// QASM 2.0 file generated by QuTiP&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s2">&quot;2.0&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s2">&quot;OPENQASM 2.0;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;QASM: Only OpenQASM 2.0 </span><span class="se">\</span>
<span class="s2">                                      is currently supported.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s1">&#39;include &quot;qelib1.inc&quot;;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">qc</span><span class="o">.</span><span class="n">_to_qasm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span>


<div class="viewcode-block" id="print_qasm"><a class="viewcode-back" href="../../../apidoc/functions.html#qutip.qip.qasm.print_qasm">[docs]</a><span class="k">def</span> <span class="nf">print_qasm</span><span class="p">(</span><span class="n">qc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Print QASM output of circuit object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    qc: :class:`.QubitCircuit`</span>
<span class="sd">        circuit object to produce QASM output for.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">qasm_out</span> <span class="o">=</span> <span class="n">QasmOutput</span><span class="p">(</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">qasm_out</span><span class="o">.</span><span class="n">_qasm_output</span><span class="p">(</span><span class="n">qc</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>


<div class="viewcode-block" id="circuit_to_qasm_str"><a class="viewcode-back" href="../../../apidoc/functions.html#qutip.qip.qasm.circuit_to_qasm_str">[docs]</a><span class="k">def</span> <span class="nf">circuit_to_qasm_str</span><span class="p">(</span><span class="n">qc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Return QASM output of circuit object as string</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    qc: :class:`.QubitCircuit`</span>
<span class="sd">        circuit object to produce QASM output for.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output: str</span>
<span class="sd">        string corresponding to QASM output.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">qasm_out</span> <span class="o">=</span> <span class="n">QasmOutput</span><span class="p">(</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">qasm_out</span><span class="o">.</span><span class="n">_qasm_output</span><span class="p">(</span><span class="n">qc</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="save_qasm"><a class="viewcode-back" href="../../../apidoc/functions.html#qutip.qip.qasm.save_qasm">[docs]</a><span class="k">def</span> <span class="nf">save_qasm</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">file_loc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Save QASM output of circuit object to file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    qc: :class:`.QubitCircuit`</span>
<span class="sd">        circuit object to produce QASM output for.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">qasm_out</span> <span class="o">=</span> <span class="n">QasmOutput</span><span class="p">(</span><span class="s2">&quot;2.0&quot;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">qasm_out</span><span class="o">.</span><span class="n">_qasm_output</span><span class="p">(</span><span class="n">qc</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_loc</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; <a href="../../../copyright.html">Copyright</a> 2011 to 2021 inclusive, QuTiP developers and contributors.
      <span class="lastupdated">
        Last updated on Dec 12, 2022.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>